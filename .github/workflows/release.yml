name: Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # Build Signed Release APK if keystore is available
      - name: Decode Keystore
        if: ${{ secrets.KEYSTORE_FILE != '' }}
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > $HOME/keystore.jks

      - name: Build Signed Release APK
        if: ${{ secrets.KEYSTORE_FILE != '' }}
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$HOME/keystore.jks \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }} \
            --stacktrace

      # Fallback: Build unsigned APK if no keystore
      - name: Build Unsigned Release APK
        if: ${{ secrets.KEYSTORE_FILE == '' }}
        run: ./gradlew assembleRelease --stacktrace

      - name: Rename and prepare APK
        run: |
          mkdir -p release-apk
          VERSION=${{ steps.get_version.outputs.VERSION }}

          # Try to find signed APK first
          if [ -f app/build/outputs/apk/release/app-release.apk ]; then
            cp app/build/outputs/apk/release/app-release.apk release-apk/GlideIME-Hungarian-${VERSION}-signed.apk
            echo "APK_TYPE=signed" >> $GITHUB_ENV
          # Fallback to unsigned APK
          elif [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
            cp app/build/outputs/apk/release/app-release-unsigned.apk release-apk/GlideIME-Hungarian-${VERSION}-unsigned.apk
            echo "APK_TYPE=unsigned" >> $GITHUB_ENV
          else
            echo "Error: No APK found!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-apk/*.apk
          body: |
            ## GlideIME-Hungarian ${{ steps.get_version.outputs.VERSION }}

            ### üì• Let√∂lt√©s

            **APK t√≠pus**: ${{ env.APK_TYPE == 'signed' && '‚úÖ Al√°√≠rt (Signed)' || '‚ö†Ô∏è Al√°√≠ratlan (Unsigned - csak Debug APK telep√≠thet≈ë)' }}

            ${{ env.APK_TYPE == 'signed' && '‚úÖ Ez az APK telep√≠thet≈ë k√∂zvetlen√ºl a k√©sz√ºl√©kedre!' || '‚ö†Ô∏è Ez az APK nem telep√≠thet≈ë (nincs al√°√≠rva). Haszn√°ld a Debug APK-t a GitHub Actions-b≈ël, vagy √°ll√≠tsd be az al√°√≠r√°st a SIGNING_SETUP.md szerint.' }}

            ### üì≤ Telep√≠t√©s

            1. T√∂ltsd le az APK f√°jlt
            2. M√°sold √°t a k√©sz√ºl√©kedre (USB / felh≈ë)
            3. Enged√©lyezd az "Ismeretlen forr√°sok" telep√≠t√©s√©t
            4. Telep√≠tsd az APK-t
            5. Aktiv√°ld a Be√°ll√≠t√°sok ‚Üí Nyelvek √©s bevitel men√ºben

            ### ‚ú® Funkci√≥k

            - Magyar QWERTZ billenty≈±zet-kioszt√°s
            - Teljes √©kezetes karakterek t√°mogat√°sa (√°, √©, √≠, √≥, √∂, ≈ë, √∫, √º, ≈±)
            - Ctrl kombin√°ci√≥k (Ctrl+C/V/X/Z/A stb.)
            - Speci√°lis karakterek Alt kombin√°ci√≥kkal
            - Intelligens Enter kezel√©s

            ### üìã K√∂vetelm√©nyek

            - Android 7.0 (API 24) vagy √∫jabb
            - Huawei k√©sz√ºl√©k fizikai billenty≈±zettel
            - HarmonyOS vagy Android oper√°ci√≥s rendszer

            ### üîß V√°ltoz√°sok

            L√°sd a [commit history](https://github.com/Szechko1/GlideIME-Hungarian/commits/${{ steps.get_version.outputs.VERSION }}) a r√©szletes v√°ltoz√°sok√©rt.

            ---

            ${{ env.APK_TYPE == 'unsigned' && '### ‚ÑπÔ∏è Al√°√≠rt APK l√©trehoz√°sa\n\nHa szeretn√©d, hogy a Release APK automatikusan al√°√≠rva legyen, k√∂vesd a [SIGNING_SETUP.md](https://github.com/Szechko1/GlideIME-Hungarian/blob/main/SIGNING_SETUP.md) √∫tmutat√≥t.' || '' }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
